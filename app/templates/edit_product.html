{% extends "base_modern.html" %}

{% block title %}Modifica Prodotto - FoodFlow{% endblock %}

{% block extra_css %}
<style>
.edit-header {
    background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
    border-radius: 20px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(59,130,246,0.3);
}

.form-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #F1F5F9;
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1E293B;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label {
    font-weight: 600;
    color: #475569;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #E2E8F0;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.form-control.changed {
    border-color: #F59E0B;
    background: rgba(245,158,11,0.05);
}

.change-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: rgba(245,158,11,0.1);
    color: #F59E0B;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

.quick-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.quick-btn {
    padding: 0.375rem 0.75rem;
    background: #F8FAFC;
    border: 2px solid #E2E8F0;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s;
}

.quick-btn:hover {
    background: #F1F5F9;
    border-color: #CBD5E1;
}

.quick-btn.selected {
    background: #3B82F6;
    color: white;
    border-color: #3B82F6;
}

.changes-summary {
    background: linear-gradient(145deg, #FEF3C7 0%, #FDE68A 100%);
    border-left: 4px solid #F59E0B;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: none;
}

.changes-summary.visible {
    display: block;
}

.change-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(245,158,11,0.2);
}

.change-item:last-child {
    border-bottom: none;
}

.btn-save {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16,185,129,0.4);
}

.btn-cancel {
    background: white;
    color: #64748B;
    border: 2px solid #E2E8F0;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-cancel:hover {
    background: #F8FAFC;
    border-color: #CBD5E1;
}

.info-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(59,130,246,0.1);
    color: #3B82F6;
    border-radius: 8px;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

@media (max-width: 768px) {
    .form-card {
        padding: 1.5rem;
    }
    
    .quick-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="edit-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h2 class="mb-2">
                            <i class="bi bi-pencil-square me-2"></i>
                            Modifica Prodotto
                        </h2>
                        <p class="mb-0 opacity-75">Aggiorna le informazioni del prodotto nella tua dispensa</p>
                    </div>
                </div>
            </div>

            <!-- Changes Summary (hidden initially) -->
            <div class="changes-summary" id="changesSummary">
                <h6 class="mb-3">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    Modifiche Rilevate
                </h6>
                <div id="changesList"></div>
            </div>

            <!-- Form -->
            <div class="form-card">
                <form method="POST" id="editForm" action="{{ url_for('edit_product', product_id=product.id) }}">
                    <!-- Sezione Informazioni Base -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-info-circle-fill text-primary"></i>
                            Informazioni Base
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">
                                    Nome Prodotto *
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ product.name }}" required 
                                       data-original="{{ product.name }}">
                                <div class="form-text">Inserisci un nome descrittivo</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="category" class="form-label">
                                    Categoria *
                                </label>
                                <select class="form-select" id="category" name="category" required
                                        data-original="{{ product.category }}">
                                    <option value="">Seleziona categoria</option>
                                    <option value="frutta" {% if product.category == 'frutta' %}selected{% endif %}>Frutta</option>
                                    <option value="verdura" {% if product.category == 'verdura' %}selected{% endif %}>Verdura</option>
                                    <option value="latticini" {% if product.category == 'latticini' %}selected{% endif %}>Latticini</option>
                                    <option value="carne" {% if product.category == 'carne' %}selected{% endif %}>Carne</option>
                                    <option value="pesce" {% if product.category == 'pesce' %}selected{% endif %}>Pesce</option>
                                    <option value="cereali" {% if product.category == 'cereali' %}selected{% endif %}>Cereali</option>
                                    <option value="condimenti" {% if product.category == 'condimenti' %}selected{% endif %}>Condimenti</option>
                                    <option value="bevande" {% if product.category == 'bevande' %}selected{% endif %}>Bevande</option>
                                    <option value="dolci" {% if product.category == 'dolci' %}selected{% endif %}>Dolci</option>
                                    <option value="altro" {% if product.category == 'altro' %}selected{% endif %}>Altro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione Quantità -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-box-seam-fill text-success"></i>
                            Quantità e Unità
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="quantity" class="form-label">
                                    Quantità *
                                </label>
                                <input type="number" step="0.1" min="0.1" class="form-control" 
                                       id="quantity" name="quantity" value="{{ product.quantity }}" required
                                       data-original="{{ product.quantity }}">
                                <div class="info-badge" id="quantityInfo" style="display: none;">
                                    <i class="bi bi-info-circle"></i>
                                    <span></span>
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="unit" class="form-label">
                                    Unità di Misura *
                                </label>
                                <select class="form-select" id="unit" name="unit" required
                                        data-original="{{ product.unit }}">
                                    <option value="">Seleziona</option>
                                    <option value="kg" {% if product.unit == 'kg' %}selected{% endif %}>Chilogrammi (kg)</option>
                                    <option value="g" {% if product.unit == 'g' %}selected{% endif %}>Grammi (g)</option>
                                    <option value="l" {% if product.unit == 'l' %}selected{% endif %}>Litri (l)</option>
                                    <option value="ml" {% if product.unit == 'ml' %}selected{% endif %}>Millilitri (ml)</option>
                                    <option value="pezzi" {% if product.unit == 'pezzi' %}selected{% endif %}>Pezzi</option>
                                    <option value="confezioni" {% if product.unit == 'confezioni' %}selected{% endif %}>Confezioni</option>
                                    <option value="bottiglie" {% if product.unit == 'bottiglie' %}selected{% endif %}>Bottiglie</option>
                                    <option value="scatole" {% if product.unit == 'scatole' %}selected{% endif %}>Scatole</option>
                                </select>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="min_quantity" class="form-label">
                                    Soglia Minima
                                </label>
                                <input type="number" step="0.1" min="0" class="form-control" 
                                       id="min_quantity" name="min_quantity" value="{{ product.min_quantity }}"
                                       data-original="{{ product.min_quantity }}">
                                <div class="form-text">Avviso scorte basse</div>
                            </div>
                        </div>

                        <!-- Quick Actions Quantità -->
                        <div class="quick-actions">
                            <button type="button" class="quick-btn" onclick="adjustQuantity(0.5)">-50%</button>
                            <button type="button" class="quick-btn" onclick="adjustQuantity(0.75)">-25%</button>
                            <button type="button" class="quick-btn" onclick="adjustQuantity(1.25)">+25%</button>
                            <button type="button" class="quick-btn" onclick="adjustQuantity(1.5)">+50%</button>
                            <button type="button" class="quick-btn" onclick="adjustQuantity(2)">Raddoppia</button>
                        </div>
                    </div>

                    <!-- Sezione Scadenza -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-calendar-event-fill text-warning"></i>
                            Data di Scadenza
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="expiry_date" class="form-label">
                                    Data di Scadenza
                                </label>
                                <input type="date" class="form-control" id="expiry_date" name="expiry_date" 
                                       value="{{ product.expiry_date.strftime('%Y-%m-%d') if product.expiry_date else '' }}"
                                       data-original="{{ product.expiry_date.strftime('%Y-%m-%d') if product.expiry_date else '' }}">
                                <div class="form-text">Lascia vuoto se non ha scadenza</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label">Giorni rimanenti</label>
                                <div class="info-badge" id="daysRemaining">
                                    <i class="bi bi-clock"></i>
                                    <span>-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions Data -->
                        <div class="quick-actions">
                            <button type="button" class="quick-btn" onclick="addDays(3)">+3 giorni</button>
                            <button type="button" class="quick-btn" onclick="addDays(7)">+7 giorni</button>
                            <button type="button" class="quick-btn" onclick="addDays(14)">+14 giorni</button>
                            <button type="button" class="quick-btn" onclick="addDays(30)">+30 giorni</button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('products') }}" class="btn btn-cancel">
                            <i class="bi bi-x-circle me-2"></i>Annulla
                        </a>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Ripristina
                            </button>
                            <button type="submit" class="btn btn-save" id="saveBtn">
                                <i class="bi bi-check-circle me-2"></i>Salva Modifiche
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Traccia modifiche
const originalValues = {};
const form = document.getElementById('editForm');

// Inizializza valori originali
document.querySelectorAll('[data-original]').forEach(field => {
    originalValues[field.id] = field.dataset.original;
});

// Monitora cambiamenti
form.addEventListener('input', function(e) {
    checkChanges();
    updateQuantityInfo();
    updateDaysRemaining();
});

function checkChanges() {
    let hasChanges = false;
    const changes = [];
    
    document.querySelectorAll('[data-original]').forEach(field => {
        const currentValue = field.value;
        const originalValue = originalValues[field.id];
        
        if (currentValue !== originalValue) {
            hasChanges = true;
            field.classList.add('changed');
            
            const label = field.closest('.mb-3').querySelector('.form-label').textContent.trim();
            changes.push({
                label: label,
                old: originalValue || '(vuoto)',
                new: currentValue || '(vuoto)'
            });
        } else {
            field.classList.remove('changed');
        }
    });
    
    // Aggiorna UI
    document.getElementById('saveBtn').disabled = !hasChanges;
    
    const summary = document.getElementById('changesSummary');
    const changesList = document.getElementById('changesList');
    
    if (hasChanges) {
        summary.classList.add('visible');
        changesList.innerHTML = changes.map(change => `
            <div class="change-item">
                <strong>${change.label}</strong>
                <span>
                    <span class="text-muted">${change.old}</span>
                    <i class="bi bi-arrow-right mx-2"></i>
                    <span class="text-primary fw-bold">${change.new}</span>
                </span>
            </div>
        `).join('');
    } else {
        summary.classList.remove('visible');
    }
}

// Quick actions quantità
function adjustQuantity(multiplier) {
    const input = document.getElementById('quantity');
    const current = parseFloat(input.value) || 0;
    input.value = (current * multiplier).toFixed(1);
    input.dispatchEvent(new Event('input'));
}

// Quick actions data
function addDays(days) {
    const input = document.getElementById('expiry_date');
    const date = input.value ? new Date(input.value) : new Date();
    date.setDate(date.getDate() + days);
    input.value = date.toISOString().split('T')[0];
    input.dispatchEvent(new Event('input'));
}

// Info quantità
function updateQuantityInfo() {
    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
    const minQuantity = parseFloat(document.getElementById('min_quantity').value) || 0;
    const unit = document.getElementById('unit').value;
    const info = document.getElementById('quantityInfo');
    const span = info.querySelector('span');
    
    if (minQuantity > 0 && quantity <= minQuantity) {
        info.style.display = 'inline-flex';
        info.style.background = 'rgba(239,68,68,0.1)';
        info.style.color = '#EF4444';
        span.textContent = 'Sotto soglia minima!';
    } else if (quantity > minQuantity * 3) {
        info.style.display = 'inline-flex';
        info.style.background = 'rgba(16,185,129,0.1)';
        info.style.color = '#10B981';
        span.textContent = 'Scorta abbondante';
    } else {
        info.style.display = 'none';
    }
}

// Giorni rimanenti
function updateDaysRemaining() {
    const expiryInput = document.getElementById('expiry_date');
    const display = document.getElementById('daysRemaining').querySelector('span');
    
    if (!expiryInput.value) {
        display.textContent = 'Nessuna scadenza';
        return;
    }
    
    const expiry = new Date(expiryInput.value);
    const today = new Date();
    const days = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    
    const parent = document.getElementById('daysRemaining');
    
    if (days < 0) {
        display.textContent = 'Scaduto!';
        parent.style.background = 'rgba(239,68,68,0.1)';
        parent.style.color = '#EF4444';
    } else if (days <= 3) {
        display.textContent = `${days} giorni (Urgente!)`;
        parent.style.background = 'rgba(239,68,68,0.1)';
        parent.style.color = '#EF4444';
    } else if (days <= 7) {
        display.textContent = `${days} giorni`;
        parent.style.background = 'rgba(245,158,11,0.1)';
        parent.style.color = '#F59E0B';
    } else {
        display.textContent = `${days} giorni`;
        parent.style.background = 'rgba(16,185,129,0.1)';
        parent.style.color = '#10B981';
    }
}

// Reset form
function resetForm() {
    document.querySelectorAll('[data-original]').forEach(field => {
        field.value = originalValues[field.id];
    });
    checkChanges();
    updateQuantityInfo();
    updateDaysRemaining();
}

// Conferma prima di uscire se ci sono modifiche
window.addEventListener('beforeunload', function(e) {
    if (!document.getElementById('saveBtn').disabled) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Inizializza
updateQuantityInfo();
updateDaysRemaining();

// Abilita submit anche senza modifiche (server valida comunque)
document.getElementById('editForm').addEventListener('submit', function(){
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';
});
</script>
{% endblock %}