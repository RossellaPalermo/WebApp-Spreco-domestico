{% extends "base_modern.html" %}

{% block title %}Analytics - FoodFlow{% endblock %}

{% block extra_css %}
<style>
    /* === ANALYTICS HERO === */
    .analytics-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
        padding: 2.5rem;
    color: white;
    margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(102,126,234,0.3);
        position: relative;
        overflow: hidden;
    }

    .analytics-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    .analytics-hero::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .analytics-hero h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .analytics-hero p {
        font-size: 1.1rem;
        opacity: 0.95;
        position: relative;
        z-index: 2;
    }

    /* === KPI CARDS === */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kpi-card {
    background: white;
    border-radius: 16px;
        padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 5px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: -50px;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, currentColor 0%, transparent 70%);
        opacity: 0.05;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .kpi-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }

    .kpi-card:hover::after {
        left: 100%;
    }

    .kpi-card.primary { border-left-color: #00D563; }
    .kpi-card.warning { border-left-color: #F59E0B; }
    .kpi-card.danger { border-left-color: #EF4444; }
    .kpi-card.info { border-left-color: #3B82F6; }

    .kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }

    .kpi-card:hover::before {
        transform: scale(1.2) rotate(45deg);
        opacity: 0.1;
    }

    .kpi-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .kpi-card.primary .kpi-icon {
        background: linear-gradient(135deg, rgba(0,213,99,0.15) 0%, rgba(0,213,99,0.05) 100%);
        color: #00D563;
    }

    .kpi-card.warning .kpi-icon {
        background: linear-gradient(135deg, rgba(245,158,11,0.15) 0%, rgba(245,158,11,0.05) 100%);
        color: #F59E0B;
    }

    .kpi-card.danger .kpi-icon {
        background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%);
        color: #EF4444;
    }

    .kpi-card.info .kpi-icon {
        background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%);
        color: #3B82F6;
    }

    .kpi-card:hover .kpi-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .kpi-value {
    font-size: 2.5rem;
        font-weight: 800;
    line-height: 1;
    margin-bottom: 0.5rem;
        color: #1F2937;
    }

    .kpi-label {
        color: #6B7280;
        font-size: 0.9rem;
    font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .kpi-trend {
        font-size: 0.85rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #F3F4F6;
        display: flex;
    align-items: center;
        gap: 0.5rem;
    }

    .kpi-trend.positive {
    color: #10B981;
}

    .kpi-trend.negative {
    color: #EF4444;
}

    /* === PERIOD SELECTOR === */
    .period-selector {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .period-btn {
        background: white;
        border: 2px solid #E5E7EB;
        padding: 0.75rem 1.75rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.9rem;
        color: #6B7280;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
    }

    .period-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(0, 213, 99, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .period-btn:active::before {
        width: 300px;
        height: 300px;
    }

    .period-btn:hover {
        background: #F9FAFB;
        border-color: #00D563;
        color: #00D563;
        transform: translateY(-2px);
    }

    .period-btn.active {
        background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
        color: white;
        border-color: #00D563;
        box-shadow: 0 4px 12px rgba(0,213,99,0.3);
    }

    .period-btn.active:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,213,99,0.4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 6px 16px rgba(0,213,99,0.4); }
        50% { box-shadow: 0 6px 16px rgba(0,213,99,0.6), 0 0 20px rgba(0,213,99,0.3); }
        100% { box-shadow: 0 6px 16px rgba(0,213,99,0.4); }
    }

    .export-btn {
        background: white;
        border: 2px solid #E5E7EB;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        color: #6B7280;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .export-btn:hover {
        background: #00D563;
        color: white;
        border-color: #00D563;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,213,99,0.3);
    }

    /* === CHARTS GRID === */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-container {
    background: white;
    border-radius: 16px;
        padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #F3F4F6;
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 0 20px rgba(0,213,99,0.2);
        transform: translateY(-4px);
    }

    .chart-container:hover .chart-title {
        color: #00D563;
        transform: scale(1.05);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #F1F5F9;
}

.chart-title {
        font-size: 1.2rem;
    font-weight: 700;
        color: #1F2937;
    display: flex;
    align-items: center;
        gap: 0.75rem;
    }

    .chart-title i {
        font-size: 1.4rem;
    }

    .chart-badge {
        padding: 0.35rem 0.85rem;
        background: #F1F5F9;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748B;
    }

    .chart-wrapper {
        position: relative;
        height: 320px;
    }

    /* === INSIGHTS SECTION === */
    .insights-section {
    background: white;
    border-radius: 16px;
        padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-top: 2rem;
    }

    .insights-header {
    display: flex;
    align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #F1F5F9;
    }

    .insights-header h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1F2937;
        margin: 0;
    }

    .insight-card {
        background: #F8FAFC;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }

    .insight-card.success { border-left-color: #10B981; }
    .insight-card.warning { border-left-color: #F59E0B; }
    .insight-card.info { border-left-color: #3B82F6; }

    .insight-card:hover {
        background: #F1F5F9;
        transform: translateX(4px);
    }

    .insight-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
    }

    .insight-card.success .insight-icon {
        background: rgba(16,185,129,0.15);
        color: #10B981;
    }

    .insight-card.warning .insight-icon {
        background: rgba(245,158,11,0.15);
        color: #F59E0B;
    }

    .insight-card.info .insight-icon {
        background: rgba(59,130,246,0.15);
        color: #3B82F6;
    }

    .insight-title {
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }

    .insight-text {
        color: #6B7280;
        font-size: 0.9rem;
        line-height: 1.6;
    }

    /* === LOADING STATE === */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
        display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        text-align: center;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #E5E7EB;
        border-top-color: #00D563;
    border-radius: 50%;
    animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

    /* === PARTICLES BACKGROUND === */
    .particles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }

    .particle {
        position: absolute;
        background: rgba(0, 213, 99, 0.1);
        border-radius: 50%;
        animation: particleFloat 20s infinite linear;
    }

    .particle:nth-child(1) { width: 4px; height: 4px; left: 10%; animation-delay: 0s; }
    .particle:nth-child(2) { width: 6px; height: 6px; left: 20%; animation-delay: 2s; }
    .particle:nth-child(3) { width: 3px; height: 3px; left: 30%; animation-delay: 4s; }
    .particle:nth-child(4) { width: 5px; height: 5px; left: 40%; animation-delay: 6s; }
    .particle:nth-child(5) { width: 4px; height: 4px; left: 50%; animation-delay: 8s; }
    .particle:nth-child(6) { width: 7px; height: 7px; left: 60%; animation-delay: 10s; }
    .particle:nth-child(7) { width: 3px; height: 3px; left: 70%; animation-delay: 12s; }
    .particle:nth-child(8) { width: 5px; height: 5px; left: 80%; animation-delay: 14s; }
    .particle:nth-child(9) { width: 4px; height: 4px; left: 90%; animation-delay: 16s; }
    .particle:nth-child(10) { width: 6px; height: 6px; left: 95%; animation-delay: 18s; }

    @keyframes particleFloat {
        0% {
            transform: translateY(100vh) rotate(0deg);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            transform: translateY(-100vh) rotate(360deg);
            opacity: 0;
        }
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
}

@media (max-width: 768px) {
        .analytics-hero {
            padding: 1.5rem;
        }

        .analytics-hero h1 {
            font-size: 1.75rem;
        }

        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .kpi-value {
        font-size: 2rem;
    }

        .period-selector {
            flex-direction: column;
        }

        .period-btn {
            width: 100%;
            justify-content: center;
        }

        .chart-wrapper {
            height: 280px;
    }
    
    .chart-header {
        flex-direction: column;
        align-items: flex-start;
            gap: 0.75rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Particles Background -->
<div class="particles-container">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<div class="container-fluid py-4">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p style="color: #6B7280; font-weight: 600;">Caricamento dati...</p>
        </div>
    </div>

    <!-- Analytics Hero -->
    <div class="analytics-hero" data-aos="fade-down" data-aos-duration="800">
        <h1>
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Analytics Dashboard
                </h1>
        <p>Monitora le tue performance e ottimizza la gestione del cibo con insights intelligenti</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" data-aos="fade-up" data-aos-duration="800" data-aos-delay="200">
        <div class="kpi-card primary" data-aos="zoom-in" data-aos-delay="300">
            <div class="kpi-icon">
                <i class="bi bi-bullseye"></i>
                </div>
            <div class="kpi-value" id="goalCompletion">0%</div>
            <div class="kpi-label">Obiettivo Nutrizionale</div>
            <div class="kpi-trend positive">
                <i class="bi bi-arrow-up-circle-fill"></i>
                <span>On track!</span>
            </div>
        </div>

        <div class="kpi-card warning" data-aos="zoom-in" data-aos-delay="400">
            <div class="kpi-icon">
                    <i class="bi bi-trash3-fill"></i>
                </div>
            <div class="kpi-value" id="wasteKg">0 kg</div>
            <div class="kpi-label">Sprechi Ridotti</div>
            <div class="kpi-trend negative">
                <i class="bi bi-arrow-down-circle-fill"></i>
                <span>Da migliorare</span>
            </div>
        </div>

        <div class="kpi-card info" data-aos="zoom-in" data-aos-delay="500">
            <div class="kpi-icon">
                    <i class="bi bi-cart-check-fill"></i>
                </div>
            <div class="kpi-value" id="totalProducts">0</div>
            <div class="kpi-label">Prodotti Gestiti</div>
            <div class="kpi-trend positive">
                <i class="bi bi-arrow-up-circle-fill"></i>
                <span>+12% vs mese scorso</span>
            </div>
        </div>

        <div class="kpi-card danger" data-aos="zoom-in" data-aos-delay="600">
            <div class="kpi-icon">
                    <i class="bi bi-currency-euro"></i>
                </div>
            <div class="kpi-value" id="wasteCost">€0</div>
            <div class="kpi-label">Costo Sprechi</div>
            <div class="kpi-trend negative">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>Attenzione</span>
            </div>
        </div>
    </div>

    <!-- Period Selector -->
    <div class="period-selector">
        <button class="period-btn" data-period="7">
            <i class="bi bi-calendar-week"></i>
            Ultima settimana
        </button>
        <button class="period-btn active" data-period="30">
            <i class="bi bi-calendar-month"></i>
            Ultimi 30 giorni
        </button>
        <button class="period-btn" data-period="90">
            <i class="bi bi-calendar-range"></i>
            Ultimi 3 mesi
        </button>
        <a href="#" class="export-btn" onclick="exportData()">
            <i class="bi bi-download"></i>
            Esporta CSV
        </a>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Nutrition Chart -->
        <div class="chart-container" data-aos="fade-up" data-aos-delay="100">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-heart-pulse-fill text-success"></i>
                    Composizione Nutrizionale
                    </div>
                <span class="chart-badge">Giornaliera</span>
                </div>
            <div class="chart-wrapper">
                <canvas id="nutritionChart"></canvas>
                    </div>
                    </div>

        <!-- Waste Chart -->
        <div class="chart-container" data-aos="fade-up" data-aos-delay="200">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="bi bi-graph-down text-danger"></i>
                    Bilancio Sprechi
                    </div>
                <span class="chart-badge">Totale</span>
                    </div>
            <div class="chart-wrapper">
                <canvas id="wasteChart"></canvas>
            </div>
        </div>

        <!-- Shopping Chart -->
        <div class="chart-container" data-aos="fade-up" data-aos-delay="300">
                <div class="chart-header">
                    <div class="chart-title">
                    <i class="bi bi-cart-check-fill text-info"></i>
                    Attività Shopping
                    </div>
                <span class="chart-badge">Totale vs AI</span>
                </div>
            <div class="chart-wrapper">
                <canvas id="shoppingChart"></canvas>
                    </div>
                </div>

        <!-- Category Chart -->
        <div class="chart-container" data-aos="fade-up" data-aos-delay="400">
                <div class="chart-header">
                    <div class="chart-title">
                    <i class="bi bi-pie-chart-fill text-primary"></i>
                    Prodotti per Categoria
                    </div>
                <span class="chart-badge">Distribuzione</span>
                </div>
            <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
                    </div>
                    </div>
                </div>

    <!-- Insights Section -->
    <div class="insights-section" data-aos="fade-up" data-aos-delay="500">
        <div class="insights-header">
            <i class="bi bi-lightbulb-fill" style="font-size: 1.5rem; color: #F59E0B;"></i>
            <h3>Insights Intelligenti</h3>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="insight-card success" data-aos="fade-right" data-aos-delay="600">
                    <div class="insight-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="insight-title">Ottimo Progresso!</div>
                    <div class="insight-text">
                        Hai ridotto gli sprechi del 23% rispetto al mese scorso. Continua così!
                </div>
            </div>
        </div>

            <div class="col-md-4">
                <div class="insight-card warning" data-aos="fade-up" data-aos-delay="700">
                    <div class="insight-icon">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <div class="insight-title">Attenzione alle Verdure</div>
                    <div class="insight-text">
                        Le verdure sono la categoria con più sprechi. Prova a pianificare meglio i pasti.
                </div>
        </div>
    </div>

            <div class="col-md-4">
                <div class="insight-card info" data-aos="fade-left" data-aos-delay="800">
                    <div class="insight-icon">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div class="insight-title">Obiettivo Raggiunto</div>
                    <div class="insight-text">
                        Hai completato il <span id="goalCompletionText">0%</span> del tuo obiettivo nutrizionale settimanale!
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dati dal server (manteniamo la logica attuale)
const analyticsData = JSON.parse('{{ analytics | tojson | safe }}');
let charts = {};

// Configurazione Chart.js globale
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.color = '#6B7280';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics data:', analyticsData);
    
    // Inizializza AOS
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });
    }
    
    updateKPIs();
    createCharts();
});

function updateKPIs() {
    // Manteniamo la logica attuale per i KPI con animazione
    animateValue('goalCompletion', 0, Math.round(analyticsData.nutrition?.goal_completion || 0), 2000, '%');
    animateValue('wasteKg', 0, analyticsData.waste?.total_kg_wasted || 0, 2000, ' kg', 1);
    animateValue('totalProducts', 0, analyticsData.shopping?.total_items_purchased || 0, 2000, '');
    animateValue('wasteCost', 0, analyticsData.waste?.total_cost || 0, 2000, '€', 2);
    
    // Aggiorna anche il testo nell'insight
    document.getElementById('goalCompletionText').textContent = 
        Math.round(analyticsData.nutrition?.goal_completion || 0) + '%';
}

function animateValue(elementId, start, end, duration, suffix = '', decimals = 0) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startTime = performance.now();
    
    function updateValue(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-out)
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * easeOut;
        
        if (decimals > 0) {
            element.textContent = current.toFixed(decimals) + suffix;
        } else {
            element.textContent = Math.round(current) + suffix;
        }
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        }
    }
    
    requestAnimationFrame(updateValue);
}

function createCharts() {
    // Manteniamo la logica attuale per i grafici
    createNutritionChart();
    createWasteChart();
    createShoppingChart();
    createCategoryChart();
}

function createNutritionChart() {
    const ctx = document.getElementById('nutritionChart');
    if (!ctx) return;
    
    charts.nutrition = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Proteine', 'Carboidrati', 'Grassi', 'Fibre'],
            datasets: [{
                data: [
                    analyticsData.nutrition?.avg_protein || 0,
                    analyticsData.nutrition?.avg_carbs || 0,
                    analyticsData.nutrition?.avg_fat || 0,
                    analyticsData.nutrition?.avg_fiber || 0
                ],
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#9C27B0'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: '600' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    borderRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(1) + 'g';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}

function createWasteChart() {
    const ctx = document.getElementById('wasteChart');
    if (!ctx) return;
    
    // Manteniamo la logica attuale per il waste chart
    charts.waste = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Prodotti Sprecati', 'Prodotti Salvati'],
            datasets: [{
                data: [
                    analyticsData.waste?.total_products_wasted || 0,
                    (analyticsData.shopping?.total_items_purchased || 0) - (analyticsData.waste?.total_products_wasted || 0)
                ],
                backgroundColor: ['#EF4444', '#10B981'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: '600' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    borderRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' prodotti';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}

function createShoppingChart() {
    const ctx = document.getElementById('shoppingChart');
    if (!ctx) return;
    
    // Manteniamo la logica attuale per il shopping chart
    charts.shopping = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Prodotti Totali', 'AI Usati'],
            datasets: [{
                data: [
                    analyticsData.shopping?.total_items_purchased || 0,
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.3)
                ],
                backgroundColor: ['#3B82F6', '#10B981'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: '600' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    borderRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' prodotti';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}

function createCategoryChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    // Manteniamo la logica attuale per il category chart
    charts.category = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Frutta', 'Verdura', 'Carne', 'Pesce', 'Latticini', 'Altro'],
            datasets: [{
                data: [
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.25),
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.30),
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.15),
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.10),
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.15),
                    Math.round((analyticsData.shopping?.total_items_purchased || 0) * 0.05)
                ],
                backgroundColor: ['#10B981', '#22C55E', '#EF4444', '#3B82F6', '#F59E0B', '#8B5CF6'],
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    borderRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.y + ' prodotti';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#F1F5F9' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
}

// Period Selector Handler (manteniamo la logica attuale)
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.classList.contains('export-btn')) return;
        
        const period = this.dataset.period;
        if (!period) return;
        
        // Update active state
        document.querySelectorAll('.period-btn').forEach(b => {
            if (!b.classList.contains('export-btn')) {
                b.classList.remove('active');
            }
        });
        this.classList.add('active');
        
        // Per ora non facciamo nulla, ma qui potresti aggiungere logica per filtrare i dati
        console.log('Period selected:', period);
    });
});

// Export function (placeholder)
function exportData() {
    alert('Funzione di esportazione in arrivo!');
}

// Notification Helper
function showNotification(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.style.zIndex = '10000';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 5000);
}
</script>
{% endblock %}