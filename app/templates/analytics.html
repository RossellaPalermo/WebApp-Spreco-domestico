{% extends "base_modern.html" %}

{% block title %}Analytics - FoodFlow{% endblock %}

{% block extra_css %}
<style>
:root {
    --chart-primary: #00D563;
    --chart-success: #10B981;
    --chart-warning: #F59E0B;
    --chart-danger: #EF4444;
    --chart-info: #3B82F6;
    --chart-purple: #9C27B0;
}

.analytics-header {
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    border-radius: 20px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,213,99,0.3);
}

.metric-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s;
    height: 100%;
    border: 2px solid transparent;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border-color: var(--chart-primary);
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    margin-bottom: 1rem;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #64748B;
    font-size: 0.875rem;
    font-weight: 500;
}

.metric-trend {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.metric-trend.up {
    background: rgba(16,185,129,0.1);
    color: #10B981;
}

.metric-trend.down {
    background: rgba(239,68,68,0.1);
    color: #EF4444;
}

.metric-trend.stable {
    background: rgba(245,158,11,0.1);
    color: #F59E0B;
}

.chart-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #F1F5F9;
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1E293B;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-actions {
    display: flex;
    gap: 0.5rem;
}

.filter-bar {
    background: white;
    border-radius: 16px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.filter-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #E2E8F0;
    background: white;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
}

.filter-btn:hover {
    border-color: var(--chart-primary);
    background: rgba(0,213,99,0.1);
}

.filter-btn.active {
    background: var(--chart-primary);
    color: white;
    border-color: var(--chart-primary);
}

.export-btn {
    padding: 0.5rem 1.5rem;
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,213,99,0.4);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    background: #F8FAFC;
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
}

.stat-item h4 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stat-item small {
    color: #64748B;
    font-size: 0.875rem;
}

.comparison-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #E2E8F0;
    border-top-color: var(--chart-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state i {
    font-size: 4rem;
    color: #CBD5E1;
    margin-bottom: 1rem;
}

.empty-state h4 {
    color: #64748B;
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: #94A3B8;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-wrap: wrap;
    }
    
    .metric-value {
        font-size: 2rem;
    }
    
    .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="analytics-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Analytics Dashboard
                </h1>
                <p class="mb-0 opacity-75">Analisi intelligente del tuo ecosistema alimentare</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <button class="export-btn" onclick="exportAnalytics()">
                    <i class="bi bi-download me-2"></i>Esporta Dati
                </button>
            </div>
        </div>
    </div>

    {% if analytics %}
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <label class="fw-bold text-muted me-2">Periodo:</label>
            <button class="filter-btn" onclick="loadPeriod(7)" data-period="7">7 giorni</button>
            <button class="filter-btn active" onclick="loadPeriod(30)" data-period="30">30 giorni</button>
            <button class="filter-btn" onclick="loadPeriod(90)" data-period="90">90 giorni</button>
        </div>
        
        <div class="filter-group">
            <label class="fw-bold text-muted me-2">Confronta:</label>
            <select class="form-select form-select-sm" style="width: auto;" onchange="compareWith(this.value)">
                <option value="">Nessuno</option>
                <option value="previous">Periodo Precedente</option>
                <option value="year">Anno Scorso</option>
            </select>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4" id="kpiCards">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(16,185,129,0.1); color: #10B981;">
                    <i class="bi bi-heart-pulse-fill"></i>
                </div>
                <div class="metric-value text-success">{{ analytics.nutrition.goal_completion|default(0) }}%</div>
                <div class="metric-label">Obiettivi Nutrizionali</div>
                <span class="metric-trend up">
                    <i class="bi bi-arrow-up"></i>+5% vs precedente
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(239,68,68,0.1); color: #EF4444;">
                    <i class="bi bi-trash3-fill"></i>
                </div>
                <div class="metric-value text-danger">{{ analytics.waste.total_kg_wasted|default(0) }}</div>
                <div class="metric-label">Kg Sprecati</div>
                <span class="metric-trend {% if analytics.waste.waste_trend == 'decreasing' %}down{% else %}up{% endif %}">
                    <i class="bi bi-arrow-{% if analytics.waste.waste_trend == 'decreasing' %}down{% else %}up{% endif %}"></i>
                    {{ analytics.waste.waste_trend|title }}
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(59,130,246,0.1); color: #3B82F6;">
                    <i class="bi bi-cart-check-fill"></i>
                </div>
                <div class="metric-value text-info">{{ analytics.shopping.total_items_purchased|default(0) }}</div>
                <div class="metric-label">Prodotti Acquistati</div>
                <span class="metric-trend stable">
                    <i class="bi bi-dash"></i>Stabile
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(245,158,11,0.1); color: #F59E0B;">
                    <i class="bi bi-currency-euro"></i>
                </div>
                <div class="metric-value text-warning">{{ analytics.waste.total_cost|default(0) }}€</div>
                <div class="metric-label">Costo Sprechi</div>
                <span class="metric-trend down">
                    <i class="bi bi-arrow-down"></i>-12% vs precedente
                </span>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row">
        <!-- Nutrition Chart -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-heart-pulse-fill text-success"></i>
                        Analisi Nutrizionale
                    </div>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType('nutritionChart', 'bar')">
                            <i class="bi bi-bar-chart-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType('nutritionChart', 'line')">
                            <i class="bi bi-graph-up"></i>
                        </button>
                    </div>
                </div>

                <div class="stats-grid mb-3">
                    <div class="stat-item">
                        <h4>{{ analytics.nutrition.avg_calories }}</h4>
                        <small>Calorie/giorno</small>
                    </div>
                    <div class="stat-item">
                        <h4>{{ analytics.nutrition.avg_protein }}g</h4>
                        <small>Proteine</small>
                    </div>
                    <div class="stat-item">
                        <h4>{{ analytics.nutrition.avg_carbs }}g</h4>
                        <small>Carboidrati</small>
                    </div>
                    <div class="stat-item">
                        <h4>{{ analytics.nutrition.avg_fat }}g</h4>
                        <small>Grassi</small>
                    </div>
                </div>

                <div style="height: 220px"><canvas id="nutritionChart"></canvas></div>
            </div>
        </div>

        <!-- Waste Trend Chart -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-trash3-fill text-danger"></i>
                        Trend Sprechi
                    </div>
                    <div class="comparison-badge" style="background: rgba(239,68,68,0.1); color: #EF4444;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        {{ analytics.waste.most_wasted_category|title }} più sprecato
                    </div>
                </div>

                <div class="stats-grid mb-3">
                    <div class="stat-item">
                        <h4>{{ analytics.waste.total_products_wasted }}</h4>
                        <small>Prodotti</small>
                    </div>
                    <div class="stat-item">
                        <h4>{{ analytics.waste.avg_daily_waste }}</h4>
                        <small>Kg/giorno</small>
                    </div>
                    <div class="stat-item">
                        <h4>{{ analytics.waste.total_cost_wasted }}€</h4>
                        <small>Costo totale</small>
                    </div>
                </div>

                <div style="height: 220px"><canvas id="wasteChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="row">
        <!-- Shopping Patterns -->
        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-cart-check-fill text-info"></i>
                        Pattern Shopping
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-semibold">Adozione AI</span>
                        <span class="fw-bold text-primary">{{ analytics.shopping.ai_adoption_rate }}%</span>
                    </div>
                    <div class="progress" style="height: 12px; border-radius: 10px;">
                        <div class="progress-bar" style="width: {{ analytics.shopping.ai_adoption_rate }}%; background: linear-gradient(90deg, #00D563, #00BCD4);" role="progressbar"></div>
                    </div>
                </div>

                <div style="height: 180px"><canvas id="shoppingChart"></canvas></div>
            </div>
        </div>

        <!-- Category Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-pie-chart-fill text-purple"></i>
                        Distribuzione Categorie
                    </div>
                </div>
                <div style="height: 180px"><canvas id="categoryChart"></canvas></div>
            </div>
        </div>

        <!-- Savings Impact -->
        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-piggy-bank-fill text-success"></i>
                        Impatto Risparmio
                    </div>
                </div>

                <div class="text-center mb-3">
                    <h2 class="text-success mb-0">{{ (analytics.shopping.total_cost|default(0) - analytics.waste.total_cost|default(0))|round(2) }}€</h2>
                    <small class="text-muted">Risparmiati grazie a FoodFlow</small>
                </div>

                <div style="height: 180px"><canvas id="savingsChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Full Width Timeline -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-calendar3 text-secondary"></i>
                        Timeline Completa
                    </div>
                    <div class="chart-actions">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary active" onclick="setTimelineView('products')">Prodotti</button>
                            <button class="btn btn-outline-primary" onclick="setTimelineView('waste')">Sprechi</button>
                            <button class="btn btn-outline-primary" onclick="setTimelineView('shopping')">Shopping</button>
                        </div>
                    </div>
                </div>
                <div style="height: 140px"><canvas id="timelineChart"></canvas></div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="chart-card">
        <div class="empty-state">
            <i class="bi bi-graph-up"></i>
            <h4>Nessun dato disponibile</h4>
            <p>Inizia a usare FoodFlow per vedere le tue analytics dettagliate</p>
            <a href="{{ url_for('add_product') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle me-2"></i>Aggiungi Primo Prodotto
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Configuration
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.color = '#64748B';

const chartColors = {
    primary: '#00D563',
    success: '#10B981',
    warning: '#F59E0B',
    danger: '#EF4444',
    info: '#3B82F6',
    purple: '#9C27B0'
};

// Global charts object
const charts = {};

// Initialize all charts
document.addEventListener('DOMContentLoaded', function() {
    // Prevent any auto-scroll by focusing a non-focusable area
    const main = document.getElementById('mainContent');
    if (main) {
        main.setAttribute('tabindex', '-1');
        main.focus({ preventScroll: true });
    }
    initNutritionChart();
    initWasteChart();
    initShoppingChart();
    initCategoryChart();
    initSavingsChart();
    initTimelineChart();
});

function initNutritionChart() {
    const ctx = document.getElementById('nutritionChart').getContext('2d');
    charts.nutrition = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Proteine', 'Carboidrati', 'Grassi', 'Fibre'],
            datasets: [{
                data: [
                    {{ analytics.nutrition.avg_protein|default(0) }},
                    {{ analytics.nutrition.avg_carbs|default(0) }},
                    {{ analytics.nutrition.avg_fat|default(0) }},
                    {{ analytics.nutrition.avg_fiber|default(0) }}
                ],
                backgroundColor: [
                    chartColors.success,
                    chartColors.info,
                    chartColors.warning,
                    chartColors.purple
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: { size: 12, weight: '600' }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + 'g';
                        }
                    }
                }
            }
        }
    });
}

function initWasteChart() {
    const ctx = document.getElementById('wasteChart').getContext('2d');
    
    const labels = [
        {% for week in analytics.trends.waste_trend %}
            '{{ week.date[8:10] }}/{{ week.date[5:7] }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const data = [
        {% for week in analytics.trends.waste_trend %}
            {{ week.kg_wasted|default(0) }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    charts.waste = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Kg Sprecati',
                data: data,
                borderColor: chartColors.danger,
                backgroundColor: 'rgba(239,68,68,0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: chartColors.danger
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#F1F5F9' },
                    ticks: { callback: (value) => value + ' kg' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
}

function initShoppingChart() {
    const ctx = document.getElementById('shoppingChart').getContext('2d');
    charts.shopping = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Totali', 'AI Usati'],
            datasets: [{
                data: [
                    {{ analytics.shopping.total_items|default(0) }},
                    Math.round({{ analytics.shopping.total_items|default(0) }} * {{ analytics.shopping.ai_adoption_rate|default(0) }} / 100)
                ],
                backgroundColor: [chartColors.info, chartColors.primary],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: '#F1F5F9' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function initCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    charts.category = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: ['Frutta', 'Verdura', 'Latticini', 'Carne', 'Altro'],
            datasets: [{
                data: [25, 20, 15, 10, 30],
                backgroundColor: [
                    chartColors.success,
                    chartColors.primary,
                    chartColors.info,
                    chartColors.danger,
                    chartColors.warning
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 10 } }
            }
        }
    });
}

function initSavingsChart() {
    const ctx = document.getElementById('savingsChart').getContext('2d');
    charts.savings = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Risparmiato', 'Sprecato'],
            datasets: [{
                data: [
                    {{ (analytics.shopping.total_cost|default(0) - analytics.waste.total_cost|default(0))|default(0) }},
                    {{ analytics.waste.total_cost|default(0) }}
                ],
                backgroundColor: [chartColors.success, chartColors.danger],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function initTimelineChart() {
    const ctx = document.getElementById('timelineChart').getContext('2d');
    
    const labels = [
        {% for day in analytics.trends.products_trend %}
            '{{ day.date[8:10] }}/{{ day.date[5:7] }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    charts.timeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Prodotti in Dispensa',
                data: [
                    {% for day in analytics.trends.products_trend %}
                        {{ day.count|default(0) }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: chartColors.primary,
                backgroundColor: 'rgba(0,213,99,0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: '#F1F5F9' } },
                x: { grid: { display: false } }
            }
        }
    });
}

// Interactive functions
function loadPeriod(days) {
    showLoading();
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period == days);
    });
    
    fetch(`/api/analytics?days=${days}`)
        .then(response => response.json())
        .then(data => {
            updateAllCharts(data);
            hideLoading();
        })
        .catch(error => {
            console.error('Error:', error);
            hideLoading();
            alert('Errore nel caricamento dei dati');
        });
}

function compareWith(period) {
    if (!period) return;
    console.log('Comparing with:', period);
    // Implement comparison logic
}

function toggleChartType(chartId, type) {
    const chart = charts[chartId.replace('Chart', '')];
    if (chart) {
        chart.config.type = type;
        chart.update();
    }
}

function setTimelineView(view) {
    console.log('Timeline view:', view);
    // Update timeline chart based on view
}

function exportAnalytics() {
    showLoading();
    
    fetch('/api/analytics/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `foodflow-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            hideLoading();
        })
        .catch(error => {
            console.error('Export error:', error);
            hideLoading();
            alert('Errore durante l\'esportazione');
        });
}

function updateAllCharts(data) {
    // Update KPI cards
    document.querySelectorAll('.metric-value').forEach((el, index) => {
        // Animate value change
        const currentValue = parseInt(el.textContent);
        const newValue = data.kpis[index];
        animateValue(el, currentValue, newValue, 500);
    });
    
    // Update charts with new data
    Object.keys(charts).forEach(key => {
        if (data.charts && data.charts[key]) {
            charts[key].data = data.charts[key];
            charts[key].update();
        }
    });
}

function animateValue(element, start, end, duration) {
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            element.textContent = Math.round(end);
            clearInterval(timer);
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Auto-refresh every 5 minutes
setInterval(() => {
    const activeBtn = document.querySelector('.filter-btn.active');
    if (activeBtn) {
        loadPeriod(parseInt(activeBtn.dataset.period));
    }
}, 300000);
</script>
{% endblock %}