<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FoodFlow - Il Tuo Ecosistema Alimentare Intelligente{% endblock %}</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* Ensure base stacking and pointer-events sane for modals */
      .modal { z-index: 2000 !important; }
      .modal-backdrop { z-index: 1990 !important; }
      body.modal-open { overflow: hidden; }
      
      /* Fix for meal planning modal - ensure proper backdrop */
      #addMealModal .modal-backdrop {
        z-index: 1990 !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
        pointer-events: auto !important;
      }
    </style>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        :root {
            /* === PALETTE DESIGN SYSTEM === */
            --primary-green: #00D563;
            --primary-green-light: #4AE189;
            --primary-green-dark: #00B350;
            --secondary-orange: #FF6B35;
            --accent-teal: #00BCD4;
            --accent-purple: #9C27B0;
            
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            /* Neutrals */
            --neutral-50: #FAFAFA;
            --neutral-100: #F5F5F5;
            --neutral-200: #E5E7EB;
            --neutral-300: #D1D5DB;
            --neutral-400: #9CA3AF;
            --neutral-500: #6B7280;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-800: #1F2937;
            --neutral-900: #111827;

            /* Gradients */
            --gradient-hero: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
            --gradient-card: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
            --gradient-glass: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            --gradient-shine: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 24px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.12);
            --shadow-glow: 0 0 20px rgba(0,213,99,0.3);

            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #F0FDF4 0%, #DBEAFE 50%, #FEF3C7 100%);
            background-attachment: fixed;
            color: var(--neutral-800);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === ANIMATED BACKGROUND === */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,213,99,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: backgroundPulse 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundPulse {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(15px, 15px); }
        }

        /* === NAVBAR ULTRA-MODERNA === */
        .navbar-modern {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 2px solid rgba(0,213,99,0.08);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            padding: 0.75rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .navbar-modern.scrolled {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem 0;
            border-bottom-color: rgba(0,213,99,0.15);
        }

        /* Brand */
        .navbar-brand-modern {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 1.75rem;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            position: relative;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
        }

        .navbar-brand-modern:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 4px 8px rgba(0,213,99,0.3));
        }

        .navbar-brand-modern i {
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: heartbeat 1.5s ease-in-out infinite;
            font-size: 1.5rem;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(0.95); }
        }

        /* Nav Links */
        .nav-link-modern {
            font-weight: 600;
            color: var(--neutral-700);
            border-radius: var(--radius-sm);
            padding: 0.5rem 1.25rem !important;
            margin: 0 0.25rem;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-shine);
            transition: var(--transition-normal);
        }

        .nav-link-modern:hover::before {
            left: 100%;
        }

        .nav-link-modern:hover {
            color: var(--primary-green);
            background: rgba(0,213,99,0.1);
            transform: translateY(-2px);
        }

        .nav-link-modern.active {
            color: white !important;
            background: var(--gradient-hero);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .nav-link-modern i {
            font-size: 1.1rem;
        }


        /* Dropdown Menu */
        .dropdown-menu {
            border: none;
            box-shadow: var(--shadow-xl);
            border-radius: var(--radius-lg);
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin-top: 0.75rem;
            border: 1px solid var(--neutral-200);
        }

        .dropdown-item {
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            transition: var(--transition-fast);
            font-weight: 500;
            color: var(--neutral-700);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dropdown-item:hover {
            background: var(--gradient-hero);
            color: white !important;
            transform: translateX(5px);
        }

        .dropdown-item i {
            transition: var(--transition-fast);
            font-size: 1.1rem;
        }

        .dropdown-item:hover i {
            transform: scale(1.2);
        }

        .dropdown-divider {
            opacity: 0.2;
            margin: 0.5rem 0;
        }

        /* === ALERTS === */
        .alert-modern {
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            border: none;
            box-shadow: var(--shadow-md);
            animation: slideInDown 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .alert-modern::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
        }

        .alert-success-modern {
            background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%);
            color: var(--success);
        }

        .alert-success-modern::before { background: var(--success); }

        .alert-warning-modern {
            background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(245,158,11,0.05) 100%);
            color: var(--warning);
        }

        .alert-warning-modern::before { background: var(--warning); }

        .alert-danger-modern {
            background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%);
            color: var(--danger);
        }

        .alert-danger-modern::before { background: var(--danger); }

        .alert-info-modern {
            background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.05) 100%);
            color: var(--info);
        }

        .alert-info-modern::before { background: var(--info); }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === FOOTER MODERNO === */
        .footer-modern {
            background: linear-gradient(135deg, var(--neutral-900) 0%, var(--neutral-800) 100%);
            color: var(--neutral-200);
            padding: 4rem 0 1.5rem;
            margin-top: 5rem;
            position: relative;
            overflow: hidden;
        }

        .footer-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-hero);
            box-shadow: var(--shadow-glow);
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2.5rem;
            margin-bottom: 3rem;
        }

        .footer-section {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .footer-section h5 {
            color: white;
            font-weight: 700;
            margin-bottom: 1.25rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .footer-section h5 i {
            color: var(--primary-green);
            font-size: 1.3rem;
        }

        .footer-section > p {
            color: var(--neutral-400);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .footer-link {
            color: var(--neutral-400);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.65rem 0;
            transition: var(--transition-normal);
            font-size: 0.95rem;
        }

        .footer-link:hover {
            color: var(--primary-green);
            transform: translateX(6px);
        }

        .footer-link i {
            font-size: 0.9rem;
            opacity: 0;
            transition: var(--transition-normal);
        }

        .footer-link:hover i {
            opacity: 1;
        }

        /* Social Links */
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .social-link {
            width: 42px;
            height: 42px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: var(--transition-normal);
            font-size: 1.1rem;
        }

        .social-link:hover {
            background: var(--gradient-hero);
            border-color: var(--primary-green);
            transform: translateY(-4px) rotate(10deg);
            box-shadow: var(--shadow-glow);
        }

        /* Newsletter Form */
        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .newsletter-form input {
            flex: 1;
            padding: 0.75rem 1.25rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 0.9rem;
            transition: var(--transition-normal);
        }

        .newsletter-form input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .newsletter-form input:focus {
            outline: none;
            border-color: var(--primary-green);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(0,213,99,0.2);
        }

        .newsletter-form button {
            padding: 0.75rem 1.75rem;
            background: var(--gradient-hero);
            color: white;
            border: none;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .newsletter-form button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        /* Sponsor Logos */
        .sponsor-logos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.25rem;
        }

        .sponsor-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1.25rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-normal);
            cursor: pointer;
        }

        .sponsor-item:hover {
            background: rgba(0,213,99,0.15);
            border-color: var(--primary-green);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,213,99,0.2);
        }

        .sponsor-logo {
            font-size: 1.75rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 213, 99, 0.15);
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .sponsor-name {
            color: var(--neutral-200);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Footer Bottom */
        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 2rem;
            text-align: center;
            color: var(--neutral-500);
        }

        .footer-bottom p {
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .footer-bottom strong {
            color: var(--primary-green);
        }

        /* === SCROLLBAR CUSTOM === */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--neutral-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-hero);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-green-dark);
        }

        /* === MAIN CONTENT === */
        .main-content {
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
            padding-top: 100px;
        }

        /* === UTILITY CLASSES === */
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        @media (max-width: 1200px) {
            .footer-content {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .navbar-brand-modern {
                font-size: 1.5rem;
            }

            .nav-link-modern {
                padding: 0.5rem 1rem !important;
                margin: 0.25rem 0;
            }

            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .navbar-brand-modern {
                font-size: 1.35rem;
            }

            .nav-link-modern {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.9rem;
            }

            .footer-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .sponsor-logos {
                grid-template-columns: repeat(2, 1fr);
            }

            .newsletter-form {
                flex-direction: column;
            }

            .newsletter-form input {
                border-radius: var(--radius-md);
            }

            .newsletter-form button {
                border-radius: var(--radius-md);
                justify-content: center;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .navbar-brand-modern {
                font-size: 1.25rem;
            }

            .nav-link-modern {
                padding: 0.4rem 0.5rem !important;
                font-size: 0.85rem;
                gap: 0.25rem;
            }

            .nav-link-modern i {
                font-size: 1rem;
            }

            .footer-section h5 {
                font-size: 1rem;
            }

            .sponsor-logos {
                grid-template-columns: 1fr;
            }

        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<!-- Widget Chatbot - Da inserire prima della chiusura del </body> in base_modern.html -->

<!-- Floating Chatbot Button -->
<div id="chatbotWidget" class="chatbot-widget">
    <!-- Toggle Button -->
    <button class="chatbot-toggle" id="chatbotToggle" aria-label="Apri FoodFlowBot">
        <i class="bi bi-chat-dots-fill chatbot-icon"></i>
        <i class="bi bi-x-lg chatbot-close-icon"></i>
        <span class="chatbot-badge" id="chatbotBadge">1</span>
    </button>

    <!-- Chat Window -->
    <div class="chatbot-window" id="chatbotWindow">
        <!-- Header -->
        <div class="chatbot-header">
            <div class="chatbot-header-content">
                <div class="chatbot-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="chatbot-header-text">
                    <h6>FoodFlowBot</h6>
                    <span class="chatbot-status">
                        <span class="status-indicator"></span>
                        Online
                    </span>
                </div>
            </div>
            <button class="chatbot-minimize" id="chatbotMinimize" aria-label="Chiudi chat">
                <i class="bi bi-dash-lg"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chatbot-message bot-message">
                <div class="message-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ðŸ‘‹ Ciao! Sono FoodFlowBot, il tuo assistente intelligente. Come posso aiutarti oggi?
                    </div>
                    <div class="message-time">Ora</div>
                </div>
            </div>


        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">
                <i class="bi bi-robot"></i>
            </div>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chatbot-input">
            <button class="chatbot-action-btn" id="attachBtn" aria-label="Allega file">
                <i class="bi bi-paperclip"></i>
            </button>
            <input 
                type="text" 
                id="chatbotInput" 
                placeholder="Scrivi un messaggio..." 
                autocomplete="off"
            />
            <button class="chatbot-send-btn" id="chatbotSend" aria-label="Invia messaggio">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>

        <!-- Powered By -->
        <div class="chatbot-footer">
            <small>Powered by <strong>AI</strong> â€¢ <a href="{{ url_for('chatbot') }}">Vai alla chat completa</a></small>
        </div>
    </div>
</div>

<style>
/* === CHATBOT WIDGET STYLES === */
.chatbot-widget {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    font-family: 'Inter', -apple-system, sans-serif;
}

/* Toggle Button */
.chatbot-toggle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    border: none;
    box-shadow: 0 8px 24px rgba(0, 213, 99, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.chatbot-toggle:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 12px 32px rgba(0, 213, 99, 0.5);
}

.chatbot-toggle:active {
    transform: scale(0.95);
}

.chatbot-icon,
.chatbot-close-icon {
    font-size: 28px;
    color: white;
    transition: all 0.3s ease;
}

.chatbot-close-icon {
    display: none;
    position: absolute;
}

.chatbot-toggle.active .chatbot-icon {
    display: none;
}

.chatbot-toggle.active .chatbot-close-icon {
    display: block;
}

/* Badge */
.chatbot-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #EF4444;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    border: 3px solid white;
    animation: badgePulse 2s ease-in-out infinite;
}

.chatbot-badge.hidden {
    display: none;
}

@keyframes badgePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

/* Chat Window */
.chatbot-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    max-width: calc(100vw - 48px);
    height: 600px;
    max-height: calc(100vh - 120px);
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
}

.chatbot-window.active {
    display: flex;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Header */
.chatbot-header {
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 20px 20px 0 0;
}

.chatbot-header-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.chatbot-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    color: white;
}

.chatbot-header-text h6 {
    margin: 0;
    color: white;
    font-size: 16px;
    font-weight: 700;
}

.chatbot-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.9);
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10B981;
    animation: statusPulse 2s ease-in-out infinite;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.chatbot-minimize {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.chatbot-minimize:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

/* Messages Area */
.chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #F8FAFC;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.chatbot-messages::-webkit-scrollbar {
    width: 6px;
}

.chatbot-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chatbot-messages::-webkit-scrollbar-thumb {
    background: #CBD5E1;
    border-radius: 10px;
}

/* Message */
.chatbot-message {
    display: flex;
    gap: 10px;
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chatbot-message.user-message {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-shrink: 0;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
}

.message-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-width: 75%;
}

.message-bubble {
    background: white;
    padding: 12px 16px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    color: #1F2937;
    line-height: 1.5;
    word-wrap: break-word;
}

.user-message .message-bubble {
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    color: white;
    border-radius: 16px 16px 4px 16px;
}

.bot-message .message-bubble {
    border-radius: 16px 16px 16px 4px;
}

.message-time {
    font-size: 11px;
    color: #9CA3AF;
    padding: 0 4px;
}

.user-message .message-time {
    text-align: right;
}



/* Typing Indicator */
.typing-indicator {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 0 20px 16px;
}

.typing-indicator.active {
    display: flex;
}

.typing-dots {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
    background: white;
    border-radius: 16px 16px 16px 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00D563;
    animation: typingDot 1.4s ease-in-out infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

/* Input Area */
.chatbot-input {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px 20px;
    background: white;
    border-top: 1px solid #E2E8F0;
}

.chatbot-action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #F1F5F9;
    border: none;
    color: #64748B;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 18px;
}

.chatbot-action-btn:hover {
    background: #E2E8F0;
    color: #00D563;
    transform: scale(1.1);
}

#chatbotInput {
    flex: 1;
    border: 2px solid #E2E8F0;
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
}

#chatbotInput:focus {
    border-color: #00D563;
    box-shadow: 0 0 0 3px rgba(0, 213, 99, 0.1);
}

.chatbot-send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00D563 0%, #00BCD4 100%);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 16px;
}

.chatbot-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 213, 99, 0.3);
}

.chatbot-send-btn:active {
    transform: scale(0.95);
}

.chatbot-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Footer */
.chatbot-footer {
    padding: 12px 20px;
    background: #F8FAFC;
    border-top: 1px solid #E2E8F0;
    text-align: center;
    font-size: 12px;
    color: #64748B;
}

.chatbot-footer a {
    color: #00D563;
    text-decoration: none;
    font-weight: 600;
}

.chatbot-footer a:hover {
    text-decoration: underline;
}

/* Responsive */
@media (max-width: 480px) {
    .chatbot-widget {
        bottom: 16px;
        right: 16px;
    }

    .chatbot-window {
        width: calc(100vw - 32px);
        height: calc(100vh - 100px);
        bottom: 70px;
        right: -8px;
    }

    .chatbot-toggle {
        width: 56px;
        height: 56px;
    }

    .chatbot-icon,
    .chatbot-close-icon {
        font-size: 24px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('chatbotToggle');
    const window = document.getElementById('chatbotWindow');
    const minimize = document.getElementById('chatbotMinimize');
    const input = document.getElementById('chatbotInput');
    const sendBtn = document.getElementById('chatbotSend');
    const messages = document.getElementById('chatbotMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const badge = document.getElementById('chatbotBadge');
    let conversationContext = [];

    // Toggle chat window
    toggle.addEventListener('click', function() {
        toggle.classList.toggle('active');
        window.classList.toggle('active');
        
        if (window.classList.contains('active')) {
            input.focus();
            badge.classList.add('hidden');
        }
    });

    minimize.addEventListener('click', function() {
        toggle.classList.remove('active');
        window.classList.remove('active');
    });

    // Send message
    sendBtn.addEventListener('click', sendMessage);
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = input.value.trim();
        
        if (!message) return;

        // Add user message
        addMessage(message, 'user');
        
        // Clear input
        input.value = '';
        
        // Show typing indicator
        typingIndicator.classList.add('active');
        
        // Scroll to bottom
        scrollToBottom();

        // Send to API
        fetch('/api/chatbot/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                context: conversationContext.slice(-5).join('\n')
            })
        })
        .then(response => response.json())
        .then(data => {
            typingIndicator.classList.remove('active');
            
            if (data.success) {
                addMessage(data.response, 'bot');
                
                // Update conversation context
                conversationContext.push(`User: ${message}`);
                conversationContext.push(`Bot: ${data.response}`);
            } else {
                addMessage('Mi dispiace, si Ã¨ verificato un errore. Riprova!', 'bot');
            }
            
            scrollToBottom();
        })
        .catch(error => {
            console.error('Error:', error);
            typingIndicator.classList.remove('active');
            addMessage('Errore di connessione. Riprova piÃ¹ tardi.', 'bot');
            scrollToBottom();
        });
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chatbot-message ${sender}-message`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('it-IT', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi bi-${sender === 'user' ? 'person-fill' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble">${text}</div>
                <div class="message-time">${timeString}</div>
            </div>
        `;
        
        messages.appendChild(messageDiv);
    }

    function scrollToBottom() {
        setTimeout(() => {
            messages.scrollTop = messages.scrollHeight;
        }, 100);
    }

    // Attach file (placeholder)
    document.getElementById('attachBtn').addEventListener('click', function() {
        alert('FunzionalitÃ  in arrivo! Presto potrai allegare immagini di prodotti.');
    });
});
</script>

<body>
    <!-- === NAVBAR === -->
    <nav class="navbar navbar-expand-lg navbar-modern" id="mainNavbar">
        <div class="container">
            <a class="navbar-brand navbar-brand-modern" href="{{ url_for('index') }}">
                <i class="bi bi-heart-pulse-fill"></i>FoodFlow
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">
                            <i class="bi bi-house-fill"></i><span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'products' %}active{% endif %}" href="{{ url_for('products') }}">
                            <i class="bi bi-box-seam-fill"></i><span>Dispensa</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'shopping_list' %}active{% endif %}" href="{{ url_for('shopping_list') }}">
                            <i class="bi bi-cart-check-fill"></i><span>Lista Spesa</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'recycling_suggestions' %}active{% endif %}" href="{{ url_for('recycling_suggestions') }}">
                            <i class="bi bi-recycle"></i><span>Riciclo</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'chatbot' %}active{% endif %}" href="{{ url_for('chatbot') }}">
                            <i class="bi bi-chat-dots"></i><span>ChatBot</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'analytics' %}active{% endif %}" href="{{ url_for('analytics') }}">
                            <i class="bi bi-graph-up"></i><span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-modern {% if request.endpoint == 'family' %}active{% endif %}" href="{{ url_for('family') }}">
                            <i class="bi bi-people"></i><span>Famiglia</span>
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav align-items-center">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-link-modern dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i><span>{{ current_user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('nutritional_profile') }}">
                                        <i class="bi bi-heart-pulse"></i>Profilo Nutrizionale
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('gamification') }}">
                                        <i class="bi bi-trophy"></i>Gamification
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                                        <i class="bi bi-box-arrow-right"></i>Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link nav-link-modern" href="{{ url_for('login') }}">
                                <i class="bi bi-box-arrow-in-right"></i><span>Login</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-link-modern" href="{{ url_for('register') }}">
                                <i class="bi bi-person-plus"></i><span>Registrati</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- === MAIN CONTENT === -->
    <main class="main-content" id="mainContent">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-modern alert-{{ category }}-modern alert-dismissible fade show fade-in-up" role="alert">
                            <i class="bi bi-{% if category == 'success' %}check-circle-fill{% elif category == 'danger' %}exclamation-triangle-fill{% elif category == 'warning' %}exclamation-circle-fill{% else %}info-circle-fill{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- === FOOTER === -->
    <footer class="footer-modern">
        <div class="container">
            <div class="footer-content">
                <!-- FoodFlow Info -->
                <div class="footer-section">
                    <h5><i class="bi bi-heart-pulse-fill"></i>FoodFlow</h5>
                    <p>Il tuo ecosistema alimentare intelligente per ridurre gli sprechi e vivere in modo sostenibile.</p>
                    <div class="social-links">
                        <a href="#" class="social-link" title="Facebook" target="_blank">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="#" class="social-link" title="Instagram" target="_blank">
                            <i class="bi bi-instagram"></i>
                        </a>
                        <a href="#" class="social-link" title="Twitter" target="_blank">
                            <i class="bi bi-twitter"></i>
                        </a>
                        <a href="#" class="social-link" title="LinkedIn" target="_blank">
                            <i class="bi bi-linkedin"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Risorse -->
                <div class="footer-section">
                    <h5><i class="bi bi-book-fill"></i>Risorse</h5>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Come funziona
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Blog
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Ricette
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Community
                    </a>
                </div>
                
                <!-- Supporto -->
                <div class="footer-section">
                    <h5><i class="bi bi-headset"></i>Supporto</h5>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Centro Assistenza
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>FAQ
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Contattaci
                    </a>
                    <a href="#" class="footer-link">
                        <i class="bi bi-arrow-right"></i>Termini di Servizio
                    </a>
                </div>
                
                <!-- Newsletter -->
                <div class="footer-section">
                    <h5><i class="bi bi-envelope-fill"></i>Newsletter</h5>
                    <p>Ricevi consigli settimanali su come ridurre gli sprechi alimentari.</p>
                    <div class="newsletter-form">
                        <input type="email" placeholder="La tua email" />
                        <button type="button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Partnership -->
                <div class="footer-section">
                    <h5><i class="bi bi-handshake"></i>Partnership</h5>
                    <p>Interessato a collaborare con FoodFlow?</p>
                    <a href="{{ url_for('sponsors') }}" class="btn btn-outline-light btn-sm mt-3" style="width: 100%;">
                        <i class="bi bi-star-fill me-2"></i>Diventa Partner
                    </a>
                </div>
            </div>
            
            <!-- Footer Bottom -->
            <div class="footer-bottom">
                <p>Â© 2025 <strong>FoodFlow</strong>. Tutti i diritti riservati.<br>
                Ãˆ vietata la riproduzione, distribuzione o modifica non autorizzata dei contenuti e del codice sorgente.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global safeguard to remove stuck backdrops after route/nav changes
      window.addEventListener('pageshow', function(){
        setTimeout(function(){
          document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
          document.body.classList.remove('modal-open');
          document.body.style.removeProperty('padding-right');
        }, 0);
      });
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Initialize AOS
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true,
                offset: 100
            });
            
        });

        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('mainNavbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });


        // Auto-hide alerts after 5 seconds
        setTimeout(() => {
            document.querySelectorAll('.alert-modern').forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // Newsletter form handler
        document.addEventListener('DOMContentLoaded', function() {
            const newsletterButtons = document.querySelectorAll('.newsletter-form button');
            newsletterButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const input = this.parentElement.querySelector('input');
                    if (input.value) {
                        alert('Grazie per esserti iscritto a FoodFlow Newsletter!');
                        input.value = '';
                    }
                });
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>