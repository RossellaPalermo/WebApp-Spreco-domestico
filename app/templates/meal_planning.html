{% extends "base_modern.html" %}

{% block title %}Piano Pasti - FoodFlow{% endblock %}

{% block extra_css %}
<style>
.meal-planning-header {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    border-radius: 20px;
    padding: 2.5rem;
    color: white;
    margin-bottom: 2.5rem;
    box-shadow: 0 15px 40px rgba(16,185,129,0.25);
}

.week-navigator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.09);
    margin-bottom: 2.5rem;
    border: 2px solid #F1F5F9;
}

.week-navigator button {
    padding: 0.75rem 1.5rem;
    border: 2px solid #E5E7EB;
    background: white;
    border-radius: 10px;
    font-weight: 600;
    color: #1E293B;
    cursor: pointer;
    transition: all 0.3s ease;
}

.week-navigator button:hover {
    border-color: #10B981;
    color: #10B981;
    background: rgba(16,185,129,0.05);
    transform: translateY(-2px);
}

/* === SERVINGS SELECTOR === */
.servings-selector-card {
    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    border: 2px solid #E5E7EB;
    margin-bottom: 2.5rem;
    position: relative;
    overflow: hidden;
}

.servings-selector-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(16,185,129,0.08) 0%, transparent 70%);
    border-radius: 50%;
}

.servings-info h5 {
    color: #1E293B;
    font-weight: 700;
}

.servings-control {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.servings-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
}

.servings-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid #E5E7EB;
    background: white;
    color: #10B981;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.servings-btn:hover {
    background: #10B981;
    color: white;
    border-color: #10B981;
    transform: scale(1.1);
}

.servings-btn:active {
    transform: scale(0.95);
}

.servings-value-container {
    text-align: center;
    min-width: 100px;
}

.servings-value {
    font-size: 3.5rem;
    font-weight: 900;
    color: #10B981;
    line-height: 1;
    font-family: 'Poppins', sans-serif;
    text-shadow: 0 2px 8px rgba(16,185,129,0.2);
}

.servings-label {
    display: block;
    color: #64748B;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    margin-top: 0.5rem;
}

.servings-slider-container {
    position: relative;
}

.servings-slider {
    width: 100%;
    height: 8px;
    border-radius: 10px;
    background: linear-gradient(90deg, #E5E7EB 0%, #10B981 100%);
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
}

.servings-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #10B981;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(16,185,129,0.4);
    transition: all 0.3s ease;
}

.servings-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 6px 20px rgba(16,185,129,0.6);
}

.servings-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #10B981;
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 12px rgba(16,185,129,0.4);
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    color: #64748B;
    font-size: 0.75rem;
    font-weight: 600;
}

.servings-presets {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.preset-btn {
    flex: 1;
    min-width: 80px;
    padding: 0.5rem 1rem;
    border: 2px solid #E5E7EB;
    background: white;
    border-radius: 10px;
    color: #64748B;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.preset-btn:hover {
    border-color: #10B981;
    color: #10B981;
    background: rgba(16,185,129,0.05);
}

.preset-btn.active {
    background: #10B981;
    color: white;
    border-color: #10B981;
}

.servings-summary {
    padding-top: 1.5rem;
    border-top: 2px solid #F1F5F9;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.summary-item i {
    font-size: 1.8rem;
}

.summary-text {
    display: flex;
    flex-direction: column;
}

.summary-text strong {
    font-size: 1.2rem;
    color: #1E293B;
    font-weight: 700;
}

.summary-text small {
    color: #64748B;
    font-size: 0.75rem;
}

/* === CALENDAR === */
.calendar-wrapper {
    overflow-x: auto;
    margin-bottom: 2.5rem;
    border-radius: 12px;
    scroll-behavior: smooth;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(200px, 1fr));
    gap: 1.25rem;
    min-width: min-content;
    padding: 0.5rem;
}

.day-card {
    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    min-height: 500px;
    transition: all 0.3s ease;
    border: 2px solid #F1F5F9;
    position: relative;
    flex-shrink: 0;
}

.day-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #E5E7EB, #CBD5E1);
}

.day-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.1);
    border-color: #E5E7EB;
}

.day-card.today {
    border: 2px solid #10B981;
    background: linear-gradient(135deg, #F0FDF4 0%, #F8FAFC 100%);
    box-shadow: 0 8px 24px rgba(16,185,129,0.15);
}

.day-card.today::before {
    background: linear-gradient(90deg, #10B981, #059669);
}

.day-header {
    text-align: center;
    padding-bottom: 1.25rem;
    margin-bottom: 1.25rem;
    border-bottom: 2px solid #F1F5F9;
}

.day-name {
    font-weight: 800;
    color: #1E293B;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.day-date {
    color: #64748B;
    font-size: 0.9rem;
    font-weight: 500;
}

.day-card.today .day-header {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    border-radius: 12px;
    padding: 1rem;
    margin: -1.5rem -1.5rem 1.25rem -1.5rem;
    border: none;
}

.day-card.today .day-name,
.day-card.today .day-date {
    color: white;
}

.meals-container {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
}

.meal-slot {
    background: #F8FAFC;
    border-radius: 12px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px dashed #E2E8F0;
    position: relative;
    overflow: hidden;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.meal-slot::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 4px;
    background: transparent;
}

.meal-slot:hover {
    border-color: #10B981;
    background: rgba(16,185,129,0.05);
    transform: translateX(4px);
}

.meal-slot.filled {
    background: white;
    border: 2px solid #E2E8F0;
    border-left: 4px solid;
}

.meal-slot.breakfast { border-left-color: #F59E0B; }
.meal-slot.breakfast::before { background: #F59E0B; }
.meal-slot.lunch { border-left-color: #3B82F6; }
.meal-slot.lunch::before { background: #3B82F6; }
.meal-slot.dinner { border-left-color: #8B5CF6; }
.meal-slot.dinner::before { background: #8B5CF6; }
.meal-slot.snack { border-left-color: #10B981; }
.meal-slot.snack::before { background: #10B981; }

.meal-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
    font-weight: 700;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    width: fit-content;
    text-transform: uppercase;
}

.meal-type-badge.breakfast { background: rgba(245,158,11,0.15); color: #D97706; }
.meal-type-badge.lunch { background: rgba(59,130,246,0.15); color: #2563EB; }
.meal-type-badge.dinner { background: rgba(139,92,246,0.15); color: #7C3AED; }
.meal-type-badge.snack { background: rgba(16,185,129,0.15); color: #059669; }

.meal-name {
    font-weight: 700;
    color: #1E293B;
    font-size: 0.95rem;
    margin: 0.65rem 0;
    word-break: break-word;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.meal-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #64748B;
    gap: 0.5rem;
}

.add-meal-btn {
    width: 100%;
    padding: 0.65rem;
    border: 2px dashed #CBD5E1;
    background: transparent;
    border-radius: 10px;
    color: #64748B;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-meal-btn:hover {
    border-color: #10B981;
    color: #10B981;
    background: rgba(16,185,129,0.08);
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2.5rem;
}

.action-card {
    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid #F1F5F9;
}

.action-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.12);
}

.action-icon {
    width: 70px;
    height: 70px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 1.5rem;
    transition: all 0.3s ease;
}

.stats-summary {
    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.09);
    border: 2px solid #F1F5F9;
    margin-top: 2rem;
}

.stat-item {
    padding: 1.5rem;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(16,185,129,0.08) 0%, rgba(16,185,129,0.02) 100%);
}

.stat-value {
    font-size: 2.2rem;
    font-weight: 900;
    color: #1E293B;
    line-height: 1;
    margin-bottom: 0.5rem;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    color: #64748B;
    font-weight: 600;
}

@media (max-width: 1024px) {
    .calendar-grid {
        grid-template-columns: repeat(4, minmax(180px, 1fr));
    }
}

@media (max-width: 768px) {
    .meal-planning-header { padding: 2rem; }
    .calendar-grid { grid-template-columns: repeat(2, minmax(150px, 1fr)); }
    .day-card { min-height: 400px; padding: 1rem; }
    .quick-actions { grid-template-columns: 1fr; }
    .servings-selector-card { padding: 1.5rem; }
    .servings-display { gap: 1rem; }
    .servings-value { font-size: 2.5rem; }
    .servings-presets { flex-direction: column; }
    .preset-btn { flex: auto; width: 100%; }
}

@media (max-width: 480px) {
    .calendar-grid { grid-template-columns: 1fr; }
    .day-card { min-height: auto; }
}

/* === MODAL FIXES === */
#addMealModal {
    z-index: 2000 !important;
}

/* Rimuoviamo completamente il backdrop */
.modal-backdrop {
    display: none !important;
}

body.modal-open {
    overflow: auto !important; /* Permette scroll normale */
}

/* === NUTRITION GRID === */
.nutrition-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.nutrition-item {
    text-align: center;
    padding: 1rem;
    background: #F8FAFC;
    border-radius: 12px;
    border: 2px solid #E2E8F0;
    transition: all 0.3s ease;
}

.nutrition-item:hover {
    background: #F1F5F9;
    border-color: #CBD5E1;
    transform: translateY(-2px);
}

.nutrition-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.nutrition-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #64748B;
    margin-bottom: 0.25rem;
}

/* === RECIPE SECTION === */
.recipe-section {
    background: #F8FAFC;
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid #E2E8F0;
}

.recipe-content {
    margin-bottom: 1.5rem;
}

.recipe-content:last-child {
    margin-bottom: 0;
}

.recipe-text {
    background: white;
    border: 1px solid #E2E8F0;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Inter', sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    white-space: pre-wrap;
    margin: 0;
    color: #374151;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="meal-planning-header">
        <h1 class="mb-2">
            <i class="bi bi-calendar-week me-2"></i>Piano Pasti Settimanale
            <span class="badge bg-warning ms-2" style="font-size: 0.7rem;">
                <i class="bi bi-people-fill me-1"></i>Famiglia
            </span>
        </h1>
        <p class="mb-0 opacity-75">Pianifica i tuoi pasti per una nutrizione ottimale (include pasti condivisi della famiglia)</p>
    </div>

    {% if not nutritional_profile %}
    <div class="alert" style="background: rgba(59,130,246,0.1); border-left: 4px solid #3B82F6; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
        <div class="d-flex align-items-start gap-3">
            <i class="bi bi-info-circle-fill" style="font-size: 1.5rem; color: #3B82F6;"></i>
            <div>
                <h6 style="color: #1E293B; margin-bottom: 0.5rem;">Configura il Profilo Nutrizionale</h6>
                <a href="{{ url_for('nutritional_profile') }}" class="btn btn-primary btn-sm">Configura Ora</a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Selettore Porzioni Famiglia -->
    <div class="servings-selector-card">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="servings-info">
                    <h5 class="mb-2">
                        <i class="bi bi-people-fill me-2"></i>
                        Persone in Famiglia
                    </h5>
                    <p class="text-muted mb-0">
                        Imposta quante persone mangeranno. Le porzioni verranno scalate automaticamente.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="servings-control">
                    <div class="servings-display">
                        <button class="servings-btn" onclick="changeServings(-1)">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        
                        <div class="servings-value-container">
                            <div class="servings-value" id="servingsValue">2</div>
                            <small class="servings-label">persone</small>
                        </div>
                        
                        <button class="servings-btn" onclick="changeServings(1)">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    
                    <!-- Slider -->
                    <div class="servings-slider-container mt-3">
                        <input type="range" class="servings-slider" id="servingsSlider" 
                               min="1" max="12" value="2" step="1"
                               oninput="updateServingsFromSlider(this.value)">
                        <div class="slider-labels">
                            <span>1</span>
                            <span>6</span>
                            <span>12</span>
                        </div>
                    </div>
                    
                    <!-- Quick presets -->
                    <div class="servings-presets mt-3">
                        <button class="preset-btn" onclick="setServings(1)">Solo io</button>
                        <button class="preset-btn" onclick="setServings(2)">Coppia</button>
                        <button class="preset-btn" onclick="setServings(4)">Famiglia</button>
                        <button class="preset-btn" onclick="setServings(6)">Gruppo</button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <div class="week-navigator">
        <button onclick="changeWeek(-1)"><i class="bi bi-chevron-left"></i> Prec.</button>
        <div class="text-center">
            <h5 class="mb-0" id="weekTitle">Settimana Corrente</h5>
            <small class="text-muted" id="weekRange"></small>
        </div>
        <button onclick="changeWeek(1)">Succ. <i class="bi bi-chevron-right"></i></button>
    </div>

    <script id="meal-plans-data" type="application/json">{{ meal_plans_json|tojson|safe }}</script>

    <div class="calendar-wrapper">
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="quick-actions">
        <div class="action-card">
            <div class="action-icon" style="background: rgba(139,92,246,0.1); color: #8B5CF6;">
                <i class="bi bi-magic"></i>
            </div>
            <h6>Genera Piano AI</h6>
            <p class="text-muted small mb-3">L'AI crea un piano settimanale bilanciato</p>
            <div class="form-check mb-2" style="text-align:left">
                <input class="form-check-input" type="checkbox" id="aiShareFlag">
                <label class="form-check-label" for="aiShareFlag">
                    Condividi con la famiglia
                    <i class="bi bi-info-circle text-info ms-1" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="right"
                       title="Il piano terrà conto delle allergie e restrizioni dietetiche di tutti i membri della famiglia"></i>
                </label>
            </div>
            <small class="text-muted d-block mb-2" id="familyConstraintsInfo" style="display: none !important; font-size: 0.75rem; text-align: left;">
                <i class="bi bi-shield-check text-success"></i> Rispetterà i vincoli nutrizionali di tutta la famiglia
            </small>
            <button class="btn btn-primary btn-sm" onclick="generateWeeklyPlan(this)">
                <i class="bi bi-robot me-1"></i>Genera Piano
            </button>
        </div>

        <div class="action-card">
            <div class="action-icon" style="background: rgba(16,185,129,0.1); color: #10B981;">
                <i class="bi bi-cart-check"></i>
            </div>
            <h6>Sincronizza Lista Spesa</h6>
            <p class="text-muted small mb-3">Aggiungi ingredienti mancanti alla lista</p>
            <button class="btn btn-success btn-sm" onclick="syncAllToShoppingList(this)">
                <i class="bi bi-arrow-repeat me-1"></i>Sincronizza
            </button>
        </div>

        <div class="action-card">
            <div class="action-icon" style="background: rgba(245,158,11,0.1); color: #F59E0B;">
                <i class="bi bi-graph-up"></i>
            </div>
            <h6>Ottimizza Nutrizione</h6>
            <p class="text-muted small mb-3">Ricalcola calorie con AI</p>
            <button class="btn btn-warning btn-sm" onclick="optimizeNutritionAI(this)">
                <i class="bi bi-heart-pulse me-1"></i>Ottimizza
            </button>
        </div>

        <div class="action-card">
            <div class="action-icon" style="background: rgba(59,130,246,0.1); color: #3B82F6;">
                <i class="bi bi-arrow-clockwise"></i>
            </div>
            <h6>Aggiorna Dati</h6>
            <p class="text-muted small mb-3">Sincronizza analytics familiari</p>
            <button class="btn btn-info btn-sm" onclick="updateFamilyNutritionalData(this)">
                <i class="bi bi-people-fill me-1"></i>Aggiorna
            </button>
        </div>
    </div>

</div>

<!-- Modal Dettagli Pasto -->
<div class="modal fade" id="mealDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Dettagli Pasto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="mealDetailsContent">
                    <!-- Contenuto dinamico -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary" onclick="editMeal()">
                    <i class="bi bi-pencil me-1"></i>Modifica
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aggiungi Pasto -->
<div class="modal fade" id="addMealModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Aggiungi Pasto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" action="{{ url_for('meal_planning') }}" id="addMealForm">
                    <input type="hidden" id="modalDate" name="date" required>
                    <input type="hidden" id="modalMealType" name="meal_type" required>
                    <input type="hidden" id="modalServings" name="servings" value="2">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Data e Tipo</label>
                        <div class="alert alert-info mb-0">
                            <span id="modalDateDisplay"></span> • <span id="modalMealTypeDisplay"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Porzioni</label>
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-people-fill me-2"></i>
                            <span id="modalServingsDisplay">2 porzioni</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="custom_meal" class="form-label fw-bold">Descrizione Pasto</label>
                        <textarea class="form-control" id="custom_meal" name="custom_meal" rows="3" 
                                  placeholder="Es: Pasta al pomodoro con basilico fresco..." required></textarea>
                        <small class="text-muted">Descrivi il pasto in dettaglio per un calcolo più preciso delle calorie</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_shared" name="is_shared">
                        <label class="form-check-label" for="is_shared">
                            Condividi con la famiglia
                        </label>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-2"></i>Aggiungi Pasto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentWeekOffset = 0;
let mealPlans = [];
let currentServings = 2;

const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
const mealTypeLabels = {
    breakfast: { icon: 'sunrise', label: 'Colazione' },
    lunch: { icon: 'sun', label: 'Pranzo' },
    dinner: { icon: 'moon', label: 'Cena' },
    snack: { icon: 'cup', label: 'Spuntino' }
};

// ========================================
// GESTIONE PORZIONI
// ========================================

function loadServingsPreference() {
    const saved = localStorage.getItem('foodflow_servings');
    if (saved) {
        currentServings = parseInt(saved);
        updateServingsDisplay(currentServings);
    }
}

function saveServingsPreference(servings) {
    localStorage.setItem('foodflow_servings', servings);
}

function changeServings(delta) {
    const newValue = currentServings + delta;
    if (newValue >= 1 && newValue <= 12) {
        setServings(newValue);
    }
}

function setServings(value) {
    currentServings = value;
    updateServingsDisplay(value);
    saveServingsPreference(value);
    
    // Aggiorna preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Evidenzia il preset corrispondente
    const presetValues = { 0: 1, 1: 2, 2: 4, 3: 6 };
    document.querySelectorAll('.preset-btn').forEach((btn, idx) => {
        if (presetValues[idx] === value) {
            btn.classList.add('active');
        }
    });
}

function updateServingsFromSlider(value) {
    setServings(parseInt(value));
}

function updateServingsDisplay(value) {
    document.getElementById('servingsValue').textContent = value;
    document.getElementById('servingsSlider').value = value;
}


// ========================================
// CALENDARIO
// ========================================

function initCalendar() {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
    updateWeekTitle(startOfWeek);
    renderCalendar(startOfWeek);
}

function updateWeekTitle(startDate) {
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    document.getElementById('weekTitle').textContent = 
        currentWeekOffset === 0 ? 'Settimana Corrente' :
        currentWeekOffset > 0 ? `Settimana +${currentWeekOffset}` : `Settimana ${currentWeekOffset}`;
    document.getElementById('weekRange').textContent = 
        `${startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}`;
}

function renderCalendar(startDate) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    const today = new Date();
    today.setHours(0,0,0,0);
    const days = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (date.getTime() === today.getTime()) dayCard.classList.add('today');
        
        const dateStr = date.toISOString().split('T')[0];
        const dayMeals = mealPlans.filter(m => m.date === dateStr);
        
        dayCard.innerHTML = `
            <div class="day-header">
                <div class="day-name">${days[i]}</div>
                <div class="day-date">${date.getDate()} ${date.toLocaleDateString('it-IT', { month: 'short' })}</div>
            </div>
            <div class="meals-container">
                ${mealTypes.map(type => renderMealSlot(date, type, dayMeals)).join('')}
            </div>
        `;
        grid.appendChild(dayCard);
    }
}

function renderMealSlot(date, mealType, dayMeals) {
    const meal = dayMeals.find(m => m.meal_type === mealType);
    const typeInfo = mealTypeLabels[mealType];
    
    if (meal) {
        const mealServings = meal.servings || 2;
        const caloriesPerServing = Math.round((meal.calories || 0) / mealServings);
        const proteinPerServing = Math.round((meal.protein || 0) / mealServings);
        
        return `
            <div class="meal-slot filled ${mealType}" onclick="showMealDetails(${meal.id}, event)" style="cursor: pointer;">
                <div class="meal-type-badge ${mealType}">
                    <i class="bi bi-${typeInfo.icon}"></i>${typeInfo.label}
                </div>
                <div class="meal-name">${escapeHtml(meal.custom_meal)}</div>
                <div class="meal-stats">
                    <span><i class="bi bi-fire"></i> ${caloriesPerServing * currentServings} cal</span>
                    <span><i class="bi bi-people"></i> ${currentServings}×${mealServings}</span>
                </div>
                <div class="d-flex gap-1 mt-2" onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-success" onclick="addMealToShopping(${meal.id}, event)" 
                            title="Aggiungi a lista spesa">
                        <i class="bi bi-cart-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="recalculateCalories(${meal.id}, event)" 
                            title="Ricalcola calorie">
                        <i class="bi bi-calculator"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMeal(${meal.id}, event)" 
                            title="Elimina">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }
    return `
        <div class="meal-slot ${mealType}" onclick="openAddMealModal('${date.toISOString().split('T')[0]}', '${mealType}')">
            <div class="meal-type-badge ${mealType}">
                <i class="bi bi-${typeInfo.icon}"></i>${typeInfo.label}
            </div>
            <button class="add-meal-btn">
                <i class="bi bi-plus-circle"></i> Aggiungi
            </button>
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function changeWeek(offset) {
    currentWeekOffset += offset;
    initCalendar();
}

// ========================================
// MODAL GESTIONE
// ========================================

function openAddMealModal(date, mealType) {
    const typeInfo = mealTypeLabels[mealType];
    document.getElementById('modalDate').value = date;
    document.getElementById('modalMealType').value = mealType;
    document.getElementById('modalServings').value = currentServings;
    
    document.getElementById('modalDateDisplay').textContent = 
        new Date(date + 'T00:00:00').toLocaleDateString('it-IT', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        });
    document.getElementById('modalMealTypeDisplay').innerHTML = 
        `<i class="bi bi-${typeInfo.icon}"></i> ${typeInfo.label}`;
    document.getElementById('modalServingsDisplay').textContent = 
        `${currentServings} ${currentServings === 1 ? 'porzione' : 'porzioni'}`;
    document.getElementById('custom_meal').value = '';
    
    // Crea e mostra il modal SENZA backdrop
    const modalElement = document.getElementById('addMealModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // DISABILITA COMPLETAMENTE IL BACKDROP
        keyboard: true,
        focus: true
    });
    
    modal.show();
}

// ========================================
// AZIONI PASTI
// ========================================

async function deleteMeal(mealId, event) {
    event.stopPropagation();
    
    if (!confirm('Sei sicuro di voler eliminare questo pasto?')) {
        return;
    }
    
    try {
        const response = await fetch(`/meal-plan/${mealId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', 'Pasto eliminato con successo');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('danger', data.message || 'Errore durante l\'eliminazione');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showNotification('danger', 'Errore di connessione');
    }
}

async function addMealToShopping(mealId, event) {
    event.stopPropagation();
    
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch(`/meal-plan/${mealId}/to-shopping-list`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.updated > 0) {
                showNotification('success', `✅ ${data.updated} ingrediente(i) aggiunti alla lista spesa!`);
            } else {
                showNotification('info', 'Tutti gli ingredienti sono già disponibili!');
            }
        } else {
            showNotification('warning', data.message || 'Nessun ingrediente da aggiungere');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore durante la sincronizzazione');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

async function recalculateCalories(mealId, event) {
    event.stopPropagation();
    
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch(`/api/recalculate-calories/${mealId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', 'Calorie ricalcolate con successo!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('danger', data.message || 'Errore nel ricalcolo');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore di connessione');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// ========================================
// DETTAGLI PASTO
// ========================================

async function showMealDetails(mealId, event) {
    event.stopPropagation();
    
    // Mostra loading
    document.getElementById('mealDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p class="mt-2">Caricamento dettagli pasto...</p>
        </div>
    `;
    
    // Mostra il modal
    const modal = new bootstrap.Modal(document.getElementById('mealDetailsModal'), {
        backdrop: false,
        keyboard: true,
        focus: true
    });
    modal.show();
    
    try {
        // Chiama API per dettagli completi
        const response = await fetch(`/api/meal/${mealId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Errore nel caricamento');
        }
        
        const meal = data.meal;
        const typeInfo = mealTypeLabels[meal.meal_type];
        const mealServings = meal.servings || 2;
        const caloriesPerServing = Math.round((meal.calories || 0) / mealServings);
        const proteinPerServing = Math.round((meal.protein || 0) / mealServings);
        const carbsPerServing = Math.round((meal.carbs || 0) / mealServings);
        const fatPerServing = Math.round((meal.fat || 0) / mealServings);
        const fiberPerServing = Math.round((meal.fiber || 0) / mealServings);
        
        const totalCalories = caloriesPerServing * currentServings;
        const totalProtein = proteinPerServing * currentServings;
        const totalCarbs = carbsPerServing * currentServings;
        const totalFat = fatPerServing * currentServings;
        const totalFiber = fiberPerServing * currentServings;
        
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-${typeInfo.icon} me-2"></i>${typeInfo.label}
                    </h6>
                    <h4 class="mb-3">${escapeHtml(meal.name)}</h4>
                    
                    <div class="mb-3">
                        <strong>Data:</strong> ${new Date(meal.date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            day: 'numeric', 
                            month: 'long',
                            year: 'numeric'
                        })}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Porzioni:</strong> ${mealServings} per ricetta × ${currentServings} persone = ${mealServings * currentServings} porzioni totali
                    </div>
                    
                    ${meal.ai_generated ? '<div class="mb-3"><span class="badge bg-info"><i class="bi bi-robot me-1"></i>Generato da AI</span></div>' : ''}
                </div>
                
                <div class="col-md-6">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-graph-up me-2"></i>Valori Nutrizionali
                    </h6>
                    
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-danger">${totalCalories}</div>
                            <div class="nutrition-label">Calorie Totali</div>
                            <small class="text-muted">${caloriesPerServing} per porzione</small>
                        </div>
                        
                        <div class="nutrition-item">
                            <div class="nutrition-value text-primary">${totalProtein}g</div>
                            <div class="nutrition-label">Proteine</div>
                            <small class="text-muted">${proteinPerServing}g per porzione</small>
                        </div>
                        
                        <div class="nutrition-item">
                            <div class="nutrition-value text-warning">${totalCarbs}g</div>
                            <div class="nutrition-label">Carboidrati</div>
                            <small class="text-muted">${carbsPerServing}g per porzione</small>
                        </div>
                        
                        <div class="nutrition-item">
                            <div class="nutrition-value text-info">${totalFat}g</div>
                            <div class="nutrition-label">Grassi</div>
                            <small class="text-muted">${fatPerServing}g per porzione</small>
                        </div>
                        
                        <div class="nutrition-item">
                            <div class="nutrition-value text-success">${totalFiber}g</div>
                            <div class="nutrition-label">Fibre</div>
                            <small class="text-muted">${fiberPerServing}g per porzione</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-book me-2"></i>Ricetta e Procedimento
                    </h6>
                    
                    <div class="recipe-section">
                        <div class="recipe-content">
                            <h6 class="text-primary">Ingredienti:</h6>
                            <pre class="recipe-text">${escapeHtml(meal.recipe)}</pre>
                        </div>
                        
                        <div class="recipe-content">
                            <h6 class="text-success">Procedimento:</h6>
                            <pre class="recipe-text">${escapeHtml(meal.procedure)}</pre>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('mealDetailsContent').innerHTML = content;
        
    } catch (error) {
        console.error('Error loading meal details:', error);
        document.getElementById('mealDetailsContent').innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Errore nel caricamento</h5>
                <p class="text-muted">Impossibile caricare i dettagli del pasto.</p>
                <button class="btn btn-primary" onclick="showMealDetails(${mealId}, event)">Riprova</button>
            </div>
        `;
    }
}

function editMeal() {
    // Chiudi il modal dettagli
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('mealDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    // Qui potresti aprire un modal di modifica o reindirizzare
    showNotification('info', 'Funzione di modifica in arrivo!');
}

// ========================================
// AZIONI GLOBALI
// ========================================

async function generateWeeklyPlan(button) {
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';
    
    try {
        const shareWithFamily = !!document.getElementById('aiShareFlag')?.checked;
        const response = await fetch('/api/ai-meal-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                days: 7,
                servings: currentServings,
                share_with_family: shareWithFamily
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', `Piano generato per ${currentServings} persona/e!`);
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('danger', data.message || 'Errore nella generazione');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-robot me-1"></i>Genera Piano';
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore di connessione');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-robot me-1"></i>Genera Piano';
    }
}

async function syncAllToShoppingList(button) {
    if (mealPlans.length === 0) {
        showNotification('warning', 'Nessun pasto pianificato da sincronizzare');
        return;
    }
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sincronizzando...';
    
    try {
        let totalAdded = 0;
        let successCount = 0;
        
        for (const meal of mealPlans) {
            try {
                const response = await fetch(`/meal-plan/${meal.id}/to-shopping-list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success && data.updated > 0) {
                    totalAdded += data.updated;
                    successCount++;
                }
            } catch (error) {
                console.error(`Error syncing meal ${meal.id}:`, error);
            }
        }
        
        if (totalAdded > 0) {
            showNotification('success', `✅ ${totalAdded} ingredienti aggiunti da ${successCount} pasti!`);
        } else {
            showNotification('info', 'Tutti gli ingredienti sono già disponibili!');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore durante la sincronizzazione');
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Sincronizza';
    }
}

async function optimizeNutritionAI(button) {
    if (mealPlans.length === 0) {
        showNotification('warning', 'Nessun pasto da ottimizzare');
        return;
    }
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ottimizzando...';
    
    try {
        let successCount = 0;
        
        for (const meal of mealPlans) {
            try {
                const response = await fetch(`/api/recalculate-calories/${meal.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successCount++;
                }
            } catch (error) {
                console.error(`Error optimizing meal ${meal.id}:`, error);
            }
        }
        
        if (successCount > 0) {
            showNotification('success', `✅ ${successCount} pasti ottimizzati!`);
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('danger', 'Nessun pasto ottimizzato');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-heart-pulse me-1"></i>Ottimizza';
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore durante l\'ottimizzazione');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-heart-pulse me-1"></i>Ottimizza';
    }
}

// ========================================
// AGGIORNAMENTO DATI FAMILIARI
// ========================================

async function updateFamilyNutritionalData(button) {
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Aggiornamento...';
    
    try {
        const response = await fetch('/api/analytics/update-family', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('success', '✅ Analytics familiari aggiornate con successo!');
            // Ricarica la pagina per mostrare i dati aggiornati
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification('danger', 'Errore nell\'aggiornamento: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('danger', 'Errore di connessione');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// ========================================
// UTILITY
// ========================================

function showNotification(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${escapeHtml(message)}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 5000);
}

// ========================================
// INIZIALIZZAZIONE
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Carica pasti
    const jsonData = document.getElementById('meal-plans-data')?.textContent;
    try {
        mealPlans = jsonData ? JSON.parse(jsonData) : [];
        console.log('Loaded meal plans:', mealPlans.length);
    } catch (e) {
        console.error('Error parsing meal plans:', e);
        mealPlans = [];
    }
    
    // Carica preferenze porzioni
    loadServingsPreference();
    
    // Inizializza calendario
    initCalendar();
    
    
    // Cleanup modali
    const modals = ['addMealModal'];
    modals.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('hidden.bs.modal', function() {
                setTimeout(() => {
                    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('padding-right');
                }, 100);
            });
        }
    });
    
    // ========================================
    // FAMIGLIA - INFO VINCOLI
    // ========================================
    
    // Inizializza tooltip Bootstrap
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    
    // Mostra/nascondi info vincoli famiglia quando si seleziona la checkbox
    const aiShareFlag = document.getElementById('aiShareFlag');
    const familyConstraintsInfo = document.getElementById('familyConstraintsInfo');
    
    if (aiShareFlag && familyConstraintsInfo) {
        aiShareFlag.addEventListener('change', function() {
            if (this.checked) {
                familyConstraintsInfo.style.display = 'block';
                familyConstraintsInfo.style.removeProperty('display');
            } else {
                familyConstraintsInfo.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}